--[[
    SILENT AIM + ESP: DUMMY UI (THAI FULL VERSION)
    สถานะ: เพิ่ม Target Priority Fix ให้ Silent Aim เพื่อรองรับ Multi-Target
]]

-- โหลด DummyUI Library
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/x2zu/OPEN-SOURCE-UI-ROBLOX/refs/heads/main/X2ZU%20UI%20ROBLOX%20OPEN%20SOURCE/DummyUi-leak-by-x2zu/fetching-main/Tools/Framework.luau"))()

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()
local Teams = game:GetService("Teams") -- เพิ่ม Teams service สำหรับ ESP

-- ## 0. ตรวจสอบความปลอดภัย
if not getrawmetatable or not hookmetamethod then
    game.StarterGui:SetCore("SendNotification", {Title = "ข้อผิดพลาด", Text = "ตัวรันของคุณไม่รองรับฟังก์ชัน Hook!", Duration = 5})
    return
end

-- ## 1. ตัวแปรและการตั้งค่า (ปรับปรุง Target Priority)
getgenv().CheatSettings = {
    -- Silent Aim Settings
    AimEnabled = true,
    FOVSize = 150,
    ShowFOV = true,
    TeamCheck = true,
    WallCheck = false,
    CloseRangeFix = true,
    LockPart = "Head",
    TargetPriority = "FOV", -- **เพิ่ม Target Priority**
    
    -- ESP Settings (New Template Logic)
    EspEnabled = false,
    EspTeamCheck = true,
    EspShowName = true,
    EspShowHp = true,
    EspShowTeam = true,
    EspHeadboxSize = 0, -- ตั้งค่าเป็น 0 เพื่อปิด Headbox Visualization
}

local SelectedTarget = nil
local playerStates = {} 

-- Constants for ESP
local HEADBOX_TRANSPARENCY = 0.7

-- ==========================================
--           ระบบ ESP (มองทะลุ)
-- ==========================================

local function getColor(p)      
    return (p.Team and p.Team.TeamColor.Color) or Color3.new(1,1,1)      
end      

local function clearVisuals(p)      
    local state = playerStates[p]      
    if state then      
        if state.highlight then      
            state.highlight:Destroy()      
            state.highlight = nil      
        end      
        if state.esp then      
            state.esp:Destroy()      
            state.esp = nil      
        end        
        playerStates[p] = nil        
    end      
end      

local function createHighlight(character, color)      
    if not character or not character:IsDescendantOf(game) then return nil end      
    local hl = Instance.new("Highlight")      
    hl.Adornee = character      
    hl.FillColor = color      
    hl.FillTransparency = 0.75      
    hl.OutlineTransparency = 1      
    hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    hl.Parent = game.CoreGui      
    return hl      
end      

local function createBillboard(hrp, p)      
    local bb = Instance.new("BillboardGui")      
    bb.Adornee = hrp      
    bb.Size = UDim2.new(0, 150, 0, 60)      
    bb.StudsOffset = Vector3.new(0, 3, 0)       
    bb.AlwaysOnTop = true      
    bb.Parent = game.CoreGui 
      
    local function addLabel(y, txt, col)        
        local l = Instance.new("TextLabel", bb)        
        l.Size = UDim2.new(1, 0, 0, 20)        
        l.Position = UDim2.new(0, 0, 0, y)        
        l.BackgroundTransparency = 1        
        l.Text = txt        
        l.Font = Enum.Font.Bodoni        
        l.TextColor3 = col        
        l.TextStrokeTransparency = 0        
        l.TextStrokeColor3 = Color3.fromRGB(20, 20, 20)        
        l.TextSize = 18        
        return l        
    end        
      
    local nameLabel = addLabel(0, p.Name, Color3.new(1, 1, 1))        
    local hpLabel = addLabel(20, "", Color3.fromRGB(255, 100, 100))        
    local teamLabel = addLabel(40, "", Color3.fromRGB(150, 200, 255))        
      
    return bb, nameLabel, hpLabel, teamLabel      
end      

local function updateEsp(p)      
    local settings = getgenv().CheatSettings
    if not settings.EspEnabled then      
        return clearVisuals(p)      
    end      
    if not p or not p.Character or p == LocalPlayer then      
        return clearVisuals(p)      
    end      
      
    local hum = p.Character:FindFirstChildOfClass("Humanoid")        
    local hrp = p.Character:FindFirstChild("HumanoidRootPart")        
    if not hum or not hrp then        
        return clearVisuals(p)        
    end        
      
    if hum.Health <= 0 or (settings.EspTeamCheck and p.Team == LocalPlayer.Team) then
        return clearVisuals(p)        
    end        
      
    local state = playerStates[p]        
    if not state then        
        state = {}        
        playerStates[p] = state        
    end        
      
    -- Highlight ESP       
    if not state.highlight then 
        state.highlight = createHighlight(p.Character, getColor(p))        
    end        
      
    -- Billboard ESP (Name, HP, Team Info)      
    if settings.EspShowName and not state.esp then        
        state.esp, state.name, state.hp, state.team = createBillboard(hrp, p)        
    end        

    if state.esp then
        local head = p.Character:FindFirstChild("Head")
        if state.esp.Adornee ~= (head or hrp) then
            state.esp.Adornee = head or hrp
        end

        if state.name then state.name.Text = p.Name end
        if state.hp and settings.EspShowHp then 
            state.hp.Text = "HP: " .. math.floor(hum.Health) 
            state.hp.Visible = true
        elseif state.hp then
            state.hp.Visible = false
        end
        if state.team and settings.EspShowTeam then 
            state.team.Text = "Team: " .. (p.Team and p.Team.Name or "None")
            state.team.Visible = true
        elseif state.team then
            state.team.Visible = false
        end
    end
end      
      
-- Loop หลักสำหรับ ESP
task.spawn(function()
    while true do
        if getgenv().CheatSettings.EspEnabled then
            for _, p in pairs(Players:GetPlayers()) do
                if p ~= LocalPlayer then
                    updateEsp(p)
                end
            end
        else
            for _, p in pairs(Players:GetPlayers()) do
                clearVisuals(p)
            end
        end
        task.wait(0.1)
    end
end)

-- จัดการผู้เล่นเข้า/ออก/เกิด
Players.PlayerRemoving:Connect(function(plr)
    clearVisuals(plr)
end)

local function setupCharacter(p)      
    if not p or not p.Character then return end      
    local hum = p.Character:FindFirstChildOfClass("Humanoid")      
    if not hum then return end      
      
    hum.Died:Connect(function()        
        clearVisuals(p)        
    end)      
end      
      
local function onPlayerAdded(p)      
    if p == LocalPlayer then return end      
    
    p.CharacterAppearanceLoaded:Connect(function()      
        clearVisuals(p)      
        task.wait(0.1)      
        setupCharacter(p)      
    end)      
      
    p:GetPropertyChangedSignal("Team"):Connect(function()        
        clearVisuals(p)        
        if p.Character then        
            setupCharacter(p)        
        end        
    end)        
      
    if p.Character then        
        setupCharacter(p)        
    end      
end      

for _, p in pairs(Players:GetPlayers()) do      
    onPlayerAdded(p)      
end      
Players.PlayerAdded:Connect(onPlayerAdded)

-- ==========================================
--           ระบบ SILENT AIM (VISUALS)
-- ==========================================
local CurrentHighlight = nil
local CurrentTag = nil

local function ClearAimVisuals()
    if CurrentHighlight then CurrentHighlight:Destroy(); CurrentHighlight = nil end
    if CurrentTag then CurrentTag:Destroy(); CurrentTag = nil end
end

local function AddAimVisuals(target)
    if not target or not target.Parent then return end
    local Char = target.Parent
    
    if not CurrentHighlight then
        CurrentHighlight = Instance.new("Highlight")
        CurrentHighlight.FillColor = Color3.fromRGB(255, 0, 0)
        CurrentHighlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        CurrentHighlight.FillTransparency = 0.5
        CurrentHighlight.Parent = game.CoreGui
    end
    if CurrentHighlight.Adornee ~= Char then CurrentHighlight.Adornee = Char end

    if not CurrentTag then
        local Billboard = Instance.new("BillboardGui")
        Billboard.Adornee = target
        Billboard.Size = UDim2.new(0, 200, 0, 50)
        Billboard.StudsOffset = Vector3.new(0, 2.5, 0)
        Billboard.AlwaysOnTop = true
        
        local Label = Instance.new("TextLabel")
        Label.Size = UDim2.new(1, 0, 1, 0)
        Label.BackgroundTransparency = 1
        Label.Text = ">>> LOCKED <<<"
        Label.TextColor3 = Color3.fromRGB(255, 0, 0)
        Label.Font = Enum.Font.GothamBlack
        Label.TextSize = 14
        Label.TextStrokeTransparency = 0
        Label.Parent = Billboard
        
        CurrentTag = Billboard
        CurrentTag.Parent = game.CoreGui
    end
    if CurrentTag.Adornee ~= target then CurrentTag.Adornee = target end
end

-- ==========================================
--           ระบบ SILENT AIM (LOGIC)
-- ==========================================
local function IsVisible(targetPart)
    if not getgenv().CheatSettings.WallCheck then return true end
    local origin = Camera.CFrame.Position
    local direction = (targetPart.Position - origin)
    local params = RaycastParams.new()
    params.FilterDescendantsInstances = {LocalPlayer.Character, Camera}
    params.FilterType = Enum.RaycastFilterType.Exclude
    local result = workspace:Raycast(origin, direction, params)
    return (result == nil or result.Instance:IsDescendantOf(targetPart.Parent))
end

local function GetTarget()
    local MaxScore = math.huge 
    local Target = nil
    local Center = Vector2.new(Camera.ViewportSize.X / 2, Camera.ViewportSize.Y / 2)
    local LockPartName = getgenv().CheatSettings.LockPart
    local Settings = getgenv().CheatSettings

    for _, plr in pairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer and plr.Character then
            if Settings.TeamCheck and plr.Team == LocalPlayer.Team then continue end

            local Hum = plr.Character:FindFirstChild("Humanoid")
            local TargetPart = plr.Character:FindFirstChild(LockPartName) or plr.Character:FindFirstChild("Head")
            local Root = plr.Character:FindFirstChild("HumanoidRootPart")
            
            if Hum and Hum.Health > 0 and TargetPart and Root then
                local ScreenPos, OnScreen = Camera:WorldToScreenPoint(TargetPart.Position)
                
                if OnScreen then
                    local FOVDist = (Vector2.new(ScreenPos.X, ScreenPos.Y) - Center).Magnitude
                    
                    if FOVDist < Settings.FOVSize then
                        
                        -- **ตรรกะการจัดลำดับความสำคัญ (Priority Logic)**
                        local Score
                        local distanceToPlayer = (Root.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude
                        
                        if Settings.TargetPriority == "Distance" then
                            -- Priority: เลือกผู้เล่นที่อยู่ใกล้ที่สุด (ระยะทาง 3D)
                            Score = distanceToPlayer
                        else -- Default/FOV: เลือกผู้เล่นที่อยู่ใกล้ศูนย์กลางหน้าจอที่สุด
                            Score = FOVDist
                        end

                        -- การเช็คกำแพง (WallCheck) และ CloseRangeFix
                        local PassWallCheck = IsVisible(TargetPart)
                        local IsClose = distanceToPlayer < 10

                        if Settings.CloseRangeFix and IsClose then
                            -- ล็อกระยะใกล้ทันที ไม่สนกำแพง
                            if Score < MaxScore then
                                Target = TargetPart
                                MaxScore = Score
                            end
                        elseif PassWallCheck then
                            -- ถ้ามองเห็น
                            if Score < MaxScore then
                                Target = TargetPart
                                MaxScore = Score
                            end
                        end
                    end
                end
            end
        end
    end
    return Target
end

-- ==========================================
--           สร้างหน้าต่าง UI (DummyUI)
-- ==========================================
local Window = Library:Window({
    Title = "Gemini Hub [ไทย]",
    Desc = "Silent Aim + ESP",
    Icon = 105059922903197, 
    Theme = "Dark",
    Config = {
        Keybind = Enum.KeyCode.RightControl,
        Size = UDim2.new(0, 500, 0, 450)
    },
    CloseUIButton = {
        Enabled = true,
        Text = "ปิดโปร"
    }
})

-- === AIMBOT TAB ===
local AimTab = Window:Tab({Title = "ล็อคเป้า", Icon = "crosshair"}) do
    AimTab:Section({Title = "การตั้งค่าหลัก"})

    AimTab:Toggle({
        Title = "เปิด Silent Aim",
        Desc = "กระสุนเข้าหัวอัตโนมัติ",
        Value = getgenv().CheatSettings.AimEnabled,
        Callback = function(v)
            getgenv().CheatSettings.AimEnabled = v
            if not v then ClearAimVisuals() end
        end
    })

    AimTab:Dropdown({
        Title = "จุดที่ล็อค",
        List = {"Head", "HumanoidRootPart", "Torso"},
        Value = getgenv().CheatSettings.LockPart,
        Callback = function(choice)
            getgenv().CheatSettings.LockPart = choice
        end
    })
    
    AimTab:Dropdown({
        Title = "จัดลำดับความสำคัญ",
        Desc = "เลือกเป้าหมายที่ดีที่สุด",
        List = {"FOV", "Distance"},
        Value = getgenv().CheatSettings.TargetPriority,
        Callback = function(choice)
            getgenv().CheatSettings.TargetPriority = choice
        end
    })

    AimTab:Slider({
        Title = "ขนาดวงกลม (FOV)",
        Desc = "รัศมีในการล็อค",
        Min = 50,
        Max = 800,
        Rounding = 0,
        Value = getgenv().CheatSettings.FOVSize,
        Callback = function(v)
            getgenv().CheatSettings.FOVSize = v
        end
    })
    
    AimTab:Toggle({
        Title = "แสดงวงกลม",
        Value = getgenv().CheatSettings.ShowFOV,
        Callback = function(v)
            getgenv().CheatSettings.ShowFOV = v
        end
    })

    AimTab:Section({Title = "ความปลอดภัย"})

    AimTab:Toggle({
        Title = "เช็คทีมเดียวกัน",
        Desc = "ไม่ล็อคพวกเดียวกัน",
        Value = getgenv().CheatSettings.TeamCheck,
        Callback = function(v)
            getgenv().CheatSettings.TeamCheck = v
        end
    })

    AimTab:Toggle({
        Title = "เช็คกำแพง",
        Desc = "ล็อคเฉพาะตัวที่มองเห็น",
        Value = getgenv().CheatSettings.WallCheck,
        Callback = function(v)
            getgenv().CheatSettings.WallCheck = v
        end
    })
end

-- === ESP TAB ===
local EspTab = Window:Tab({Title = "มองทะลุ", Icon = "eye"}) do
    EspTab:Section({Title = "การมองเห็นหลัก"})

    EspTab:Toggle({
        Title = "เปิดใช้งาน ESP",
        Desc = "เปิด/ปิด การมองทะลุ (Highlight + Info)",
        Value = getgenv().CheatSettings.EspEnabled,
        Callback = function(v)
            getgenv().CheatSettings.EspEnabled = v
        end
    })

    EspTab:Toggle({
        Title = "ซ่อนทีมเดียวกัน",
        Desc = "ไม่แสดง ESP ฝั่งเดียวกัน",
        Value = getgenv().CheatSettings.EspTeamCheck,
        Callback = function(v)
            getgenv().CheatSettings.EspTeamCheck = v
        end
    })

    EspTab:Section({Title = "การแสดงผล"})
        
    EspTab:Toggle({
        Title = "แสดงชื่อ (Name)",
        Value = getgenv().CheatSettings.EspShowName,
        Callback = function(v)
            getgenv().CheatSettings.EspShowName = v
        end
    })
    
    EspTab:Toggle({
        Title = "แสดงเลือด (HP)",
        Value = getgenv().CheatSettings.EspShowHp,
        Callback = function(v)
            getgenv().CheatSettings.EspShowHp = v
        end
    })

    EspTab:Toggle({
        Title = "แสดงทีม (Team)",
        Value = getgenv().CheatSettings.EspShowTeam,
        Callback = function(v)
            getgenv().CheatSettings.EspShowTeam = v
        end
    })

end

-- === TELEPORT TAB ===
local TpTab = Window:Tab({Title = "วาร์ป", Icon = "map"}) do
    TpTab:Section({Title = "สถานที่"})

    TpTab:Button({
        Title = "ฐานโจร (Criminal Base)",
        Desc = "วาร์ปไปที่ (-976, 108, 2057)",
        Callback = function()
            pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(-976, 108, 2057) end)
        end
    })

    TpTab:Button({
        Title = "ฐานตำรวจ (Police Base)",
        Desc = "วาร์ปไปที่ (812, 100, 2249)",
        Callback = function()
            pcall(function() LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(812, 100, 2249) end)
        end
    })
end


-- ==========================================
--           ระบบเบื้องหลัง (FOV Circle)
-- ==========================================
local FOVGui = Instance.new("ScreenGui")
FOVGui.Name = "SilentAimFOV"
FOVGui.ResetOnSpawn = false
FOVGui.IgnoreGuiInset = true
FOVGui.Parent = game.CoreGui

local FOVCircle = Instance.new("Frame")
FOVCircle.Name = "Circle"
FOVCircle.AnchorPoint = Vector2.new(0.5, 0.5)
FOVCircle.Position = UDim2.new(0.5, 0, 0.5, 0)
FOVCircle.BackgroundColor3 = Color3.new(1,1,1)
FOVCircle.BackgroundTransparency = 1
FOVCircle.BorderSizePixel = 0
FOVCircle.Parent = FOVGui
local Stroke = Instance.new("UIStroke"); Stroke.Color = Color3.new(1,1,1); Stroke.Thickness = 1.5; Stroke.Transparency = 0.4; Stroke.Parent = FOVCircle
local CircCorner = Instance.new("UICorner"); CircCorner.CornerRadius = UDim.new(1,0); CircCorner.Parent = FOVCircle

RunService.RenderStepped:Connect(function()
    SelectedTarget = GetTarget()
    
    local size = getgenv().CheatSettings.FOVSize * 2
    FOVCircle.Size = UDim2.new(0, size, 0, size)
    FOVCircle.Visible = getgenv().CheatSettings.ShowFOV and getgenv().CheatSettings.AimEnabled
    
    if SelectedTarget and getgenv().CheatSettings.AimEnabled then
        Stroke.Color = Color3.fromRGB(255, 50, 50); Stroke.Thickness = 2
        AddAimVisuals(SelectedTarget)
    else
        Stroke.Color = Color3.fromRGB(255, 255, 255); Stroke.Thickness = 1.5
        ClearAimVisuals()
    end
end)

-- ==========================================
--           HOOK SYSTEM (Silent Aim)
-- ==========================================
local mt = getrawmetatable(game)
local oldNamecall = mt.__namecall
setreadonly(mt, false)

mt.__namecall = newcclosure(function(self, ...)
    local args = {...}
    local method = getnamecallmethod()

    if getgenv().CheatSettings.AimEnabled and SelectedTarget and not checkcaller() then
        -- Hook Raycast
        if method == "Raycast" then
            local origin = args[1]
            local direction = (SelectedTarget.Position - origin)
            
            if direction.Magnitude < 5 then
                 args[2] = direction 
            else
                 args[2] = direction.Unit * args[2].Magnitude
            end
            
            return oldNamecall(self, unpack(args))
            
        elseif method == "FindPartOnRay" then
            local ray = args[1]
            if typeof(ray) == "Ray" then
                local newRay = Ray.new(ray.Origin, (SelectedTarget.Position - ray.Origin).Unit * ray.Direction.Magnitude)
                args[1] = newRay
                return oldNamecall(self, unpack(args))
            end
        end

        -- Remote Hook (Universal Fix)
        if method == "FireServer" and (string.find(self.Name, "Shoot") or string.find(self.Name, "Fire") or string.find(self.Name, "Bullet") or string.find(self.Name, "Attack")) then
             -- หา Vector3 แล้วเปลี่ยน
             for i, v in pairs(args) do
                if typeof(v) == "Vector3" then
                    if (v - Camera.CFrame.Position).Magnitude > 2 then
                        args[i] = SelectedTarget.Position
                    end
                end
             end
             -- หาใน Table
             if type(args[1]) == "table" then
                 if args[1].p and typeof(args[1].p) == "Vector3" then args[1].p = SelectedTarget.Position end
                 if args[1][1] and type(args[1][1]) == "table" and args[1][1][2] then args[1][1][2] = SelectedTarget.Position end
             end
        end
    end

    return oldNamecall(self, unpack(args))
end)

setreadonly(mt, true)
Window:Notify({Title = "Gemini Hub", Desc = "โหลด Silent Aim + ESP เรียบร้อย!", Time = 4})
