-- Safe Runner + Basic Draggable GUI (No WindUI)
-- Features:
--  - Robust guards to avoid "attempt to call a nil value"
--  - Basic draggable GUI with Toggle + FOV Input
--  - Safe SilentAim: finds target in screen center FOV & highlights them (no remote hooks)
--  - Lightweight, throttled loops to avoid lag

-- ======= Basic waits & safety =======
repeat task.wait() until game and game:IsLoaded()

-- cloneref fallback
local cloneref = rawget(_G, "cloneref") or function(x) return x end

-- safe pcall helper
local function safe_pcall(fn, ...)
    local ok, a, b, c = pcall(fn, ...)
    return ok, a, b, c
end

-- safe notify (StarterGui)
local function safe_notify(title, text, dur)
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", { Title = tostring(title), Text = tostring(text), Duration = dur or 3 })
    end)
end

-- services (wrapped with cloneref)
local Players   = cloneref(game:GetService("Players"))
local Workspace = cloneref(game:GetService("Workspace"))
local RunService = cloneref(game:GetService("RunService"))
local UserInputService = cloneref(game:GetService("UserInputService"))

local LocalPlayer = Players and Players.LocalPlayer
if not LocalPlayer then
    safe_notify("SafeRunner", "LocalPlayer not found. Abort.", 5)
    return
end

-- ======= GUI helpers =======
local function makeDraggable(frame)
    local dragging, dragInput, dragStart, startPos
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    RunService.RenderStepped:Connect(function()
        if dragging and dragInput and dragStart and startPos then
            local delta = dragInput.Position - dragStart
            local newPos = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            frame.Position = newPos
        end
    end)
end

-- create basic GUI (or reuse existing)
local function createBasicGUI()
    local playerGui = LocalPlayer:FindFirstChildOfClass("PlayerGui") or game:GetService("CoreGui")
    local existing = playerGui:FindFirstChild("SafeRunner_GUI")
    if existing then existing:Destroy() end

    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SafeRunner_GUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui

    local frame = Instance.new("Frame", screenGui)
    frame.Name = "MainFrame"
    frame.Position = UDim2.new(0.02, 0, 0.16, 0)
    frame.Size = UDim2.new(0, 260, 0, 140)
    frame.BackgroundColor3 = Color3.fromRGB(25,25,25)
    frame.BorderSizePixel = 0
    frame.BackgroundTransparency = 0.05
    frame.Active = true

    local uicorner = Instance.new("UICorner", frame); uicorner.CornerRadius = UDim.new(0,8)

    -- Title bar for dragging
    local title = Instance.new("TextLabel", frame)
    title.Size = UDim2.new(1, 0, 0, 28)
    title.Position = UDim2.new(0,0,0,0)
    title.BackgroundTransparency = 1
    title.Text = "SafeRunner"
    title.TextColor3 = Color3.fromRGB(220,220,220)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16

    -- Toggle button
    local toggleBtn = Instance.new("TextButton", frame)
    toggleBtn.Size = UDim2.new(0, 120, 0, 34)
    toggleBtn.Position = UDim2.new(0, 10, 0, 36)
    toggleBtn.Text = "SilentAim: OFF"
    toggleBtn.Font = Enum.Font.Gotham
    toggleBtn.TextSize = 14
    toggleBtn.BackgroundColor3 = Color3.fromRGB(40,40,40)
    toggleBtn.BorderSizePixel = 0
    local tcorner = Instance.new("UICorner", toggleBtn); tcorner.CornerRadius = UDim.new(0,6)

    -- FOV label + input
    local fovLabel = Instance.new("TextLabel", frame)
    fovLabel.Position = UDim2.new(0, 10, 0, 80)
    fovLabel.Size = UDim2.new(0, 60, 0, 22)
    fovLabel.Text = "FOV"
    fovLabel.BackgroundTransparency = 1
    fovLabel.TextColor3 = Color3.fromRGB(200,200,200)
    fovLabel.Font = Enum.Font.Gotham
    fovLabel.TextSize = 14

    local fovInput = Instance.new("TextBox", frame)
    fovInput.Position = UDim2.new(0, 70, 0, 78)
    fovInput.Size = UDim2.new(0, 80, 0, 24)
    fovInput.Text = "150"
    fovInput.ClearTextOnFocus = false
    fovInput.Font = Enum.Font.Gotham
    fovInput.TextSize = 14
    fovInput.BackgroundColor3 = Color3.fromRGB(42,42,42)
    fovInput.TextColor3 = Color3.fromRGB(230,230,230)
    local fic = Instance.new("UICorner", fovInput); fic.CornerRadius = UDim.new(0,5)

    -- Close button
    local closeBtn = Instance.new("TextButton", frame)
    closeBtn.Position = UDim2.new(0, 200, 0, 36)
    closeBtn.Size = UDim2.new(0, 48, 0, 34)
    closeBtn.Text = "X"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.BackgroundColor3 = Color3.fromRGB(65,65,65)
    local ccorner = Instance.new("UICorner", closeBtn); ccorner.CornerRadius = UDim.new(0,6)

    makeDraggable(frame)

    return {
        Gui = screenGui,
        Frame = frame,
        Toggle = toggleBtn,
        FovInput = fovInput,
        Close = closeBtn
    }
end

-- ======= Safe SilentAim core (no remote hooks) =======
local function safeSilentAimModule(guiObjects)
    local state = {
        enabled = false,
        fov = 150,
        throttle = 0.12,
        lastSearch = 0,
        currentTarget = nil,
        highlight = nil
    }

    -- player cache
    local playerList = {}
    local function rebuildPlayers()
        table.clear(playerList)
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= LocalPlayer then table.insert(playerList, p) end
        end
    end
    rebuildPlayers()
    Players.PlayerAdded:Connect(function(p) if p ~= LocalPlayer then table.insert(playerList, p) end end)
    Players.PlayerRemoving:Connect(function(p)
        for i=#playerList,1,-1 do if playerList[i] == p then table.remove(playerList, i) end end
    end)

    local Camera = Workspace.CurrentCamera
    local function viewportCenter() local vs = Camera.ViewportSize return Vector2.new(vs.X/2, vs.Y/2) end

    local function findTarget()
        local now = tick()
        if now - state.lastSearch < state.throttle then return state.currentTarget end
        state.lastSearch = now

        local best, bestD = nil, math.huge
        local center = viewportCenter()
        for _, pl in ipairs(playerList) do
            local ok, char = pcall(function() return pl.Character end)
            if not ok or not char then goto cont end
            local hum = char:FindFirstChildOfClass("Humanoid")
            if not hum or hum.Health <= 0 then goto cont end
            local part = char:FindFirstChild("Head") or char.PrimaryPart or char:FindFirstChild("HumanoidRootPart")
            if not part then goto cont end
            local sx, sy, onScreen = nil, nil, false
            local ok2, vx, vy, vs = pcall(function() return Camera:WorldToViewportPoint(part.Position) end)
            if ok2 then sx, sy, onScreen = vx, vy, vs end
            if not onScreen then goto cont end
            local d = (Vector2.new(sx, sy) - center).Magnitude
            if d <= state.fov and d < bestD then best, bestD = pl, d end
            ::cont::
        end
        state.currentTarget = best
        return best
    end

    local function clearHighlight()
        if state.highlight then pcall(function() state.highlight:Destroy() end) end
        state.highlight = nil
        state.currentTarget = nil
    end

    local function applyHighlight(pl)
        clearHighlight()
        if not pl or not pl.Character then return end
        pcall(function()
            local hl = Instance.new("Highlight")
            hl.Adornee = pl.Character
            hl.FillTransparency = 0.7
            hl.OutlineTransparency = 1
            hl.FillColor = (pl.Team and pl.Team.TeamColor and pl.Team.TeamColor.Color) or Color3.new(1,1,1)
            hl.Parent = pl.Character
            state.highlight = hl
        end)
    end

    -- UI linkage
    if guiObjects and guiObjects.FovInput then
        guiObjects.FovInput.FocusLost:Connect(function(enter)
            local txt = guiObjects.FovInput.Text
            local n = tonumber(txt)
            if n and n >= 10 and n <= 2000 then
                state.fov = n
                safe_notify("SafeSilentAim", "FOV set to "..tostring(n), 2)
            else
                guiObjects.FovInput.Text = tostring(state.fov)
                safe_notify("SafeSilentAim", "Invalid FOV (10-2000)", 2)
            end
        end)
    end

    -- background search loop (throttled)
    task.spawn(function()
        while true do
            local ok, tgt = pcall(findTarget)
            if ok and state.enabled and tgt then
                if state.currentTarget ~= tgt then applyHighlight(tgt) end
            else
                clearHighlight()
            end
            task.wait(0.12)
        end
    end)

    -- Public API
    return {
        toggle = function()
            state.enabled = not state.enabled
            if not state.enabled then clearHighlight() end
            if guiObjects and guiObjects.Toggle then
                guiObjects.Toggle.Text = "SilentAim: " .. (state.enabled and "ON" or "OFF")
            end
        end,
        enable = function() state.enabled = true; if guiObjects and guiObjects.Toggle then guiObjects.Toggle.Text = "SilentAim: ON" end end,
        disable = function() state.enabled = false; clearHighlight(); if guiObjects and guiObjects.Toggle then guiObjects.Toggle.Text = "SilentAim: OFF" end end,
        isEnabled = function() return state.enabled end,
        setFov = function(n) state.fov = tonumber(n) or state.fov end
    }
end

-- ======= Main guarded runner =======
local function safeMain()
    -- build GUI
    local gui = createBasicGUI()

    -- attach close
    gui.Close.MouseButton1Click:Connect(function()
        local parent = gui.Gui.Parent
        if parent then
            pcall(function() gui.Gui:Destroy() end)
        end
    end)

    -- create module
    local silentAim = safeSilentAimModule(gui)

    -- toggle button binding
    gui.Toggle.MouseButton1Click:Connect(function()
        pcall(function() silentAim.toggle() end)
    end)

    -- keybind: toggle with "T" by default (you can change)
    local TOGGLE_KEY = Enum.KeyCode.T
    UserInputService.InputBegan:Connect(function(input, typing)
        if typing then return end
        if input.KeyCode == TOGGLE_KEY then
            pcall(function() silentAim.toggle() end)
        end
    end)

    safe_notify("SafeRunner", "GUI loaded. Toggle SilentAim via UI or T.", 4)

    -- expose globally for quick testing
    _G.SafeRunner = _G.SafeRunner or {}
    _G.SafeRunner.SilentAim = silentAim
end

-- run guarded
local ok, err = pcall(safeMain)
if not ok then
    warn("[SafeRunner] safeMain error:", err)
    safe_notify("SafeRunner Error", tostring(err), 6)
end

-- small protection: ensure script doesn't spam nil-call errors
if type(task) ~= "table" then
    task = { wait = function(t) os.execute("sleep " .. (tonumber(t) or 0.03)) end }
end

-- End of script
